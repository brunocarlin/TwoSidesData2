---
title: Classification - KNN
authors: 
- admin
date: '2019-08-15'
slug: classification-knn
categories:
  - r-project
tags:
  - tidyverse
  - tidymodels
image:
  caption: ''
  focal_point: ''
---



<p>Breast Cancer problem.</p>
<div id="setting-up-rmarkdown" class="section level1">
<h1>Setting up Rmarkdown</h1>
<p>root.dir =</p>
</div>
<div id="loading-librais" class="section level1">
<h1>Loading Librais</h1>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages ---------------------------------- tidyverse 1.2.1 --</code></pre>
<pre><code>## v ggplot2 3.2.1     v purrr   0.3.2
## v tibble  2.1.3     v dplyr   0.8.3
## v tidyr   0.8.3     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.4.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------- tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(tidymodels)</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;xts&#39;:
##   method     from
##   as.zoo.xts zoo</code></pre>
<pre><code>## -- Attaching packages --------------------------------- tidymodels 0.0.2 --</code></pre>
<pre><code>## v broom     0.5.2       v recipes   0.1.6  
## v dials     0.0.2       v rsample   0.0.5  
## v infer     0.4.0.1     v yardstick 0.0.3  
## v parsnip   0.0.3.1</code></pre>
<pre><code>## -- Conflicts ------------------------------------ tidymodels_conflicts() --
## x scales::discard() masks purrr::discard()
## x dplyr::filter()   masks stats::filter()
## x recipes::fixed()  masks stringr::fixed()
## x dplyr::lag()      masks stats::lag()
## x yardstick::spec() masks readr::spec()
## x recipes::step()   masks stats::step()</code></pre>
<pre class="r"><code>library(janitor)</code></pre>
<pre><code>## 
## Attaching package: &#39;janitor&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     chisq.test, fisher.test</code></pre>
<pre class="r"><code>library(skimr)</code></pre>
<pre><code>## 
## Attaching package: &#39;skimr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:knitr&#39;:
## 
##     kable</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     filter</code></pre>
<pre class="r"><code>library(DataExplorer)</code></pre>
<p>Loading Libraries: 4.87 sec elapsed</p>
</div>
<div id="getting-data" class="section level1">
<h1>Getting Data</h1>
<p>Got the dataset with headers on <a href="https://www.kaggle.com/uciml/breast-cancer-wisconsin-data/version/2">kaggle link</a></p>
<pre class="r"><code>df &lt;- read_csv(&quot;breast_cancer.csv&quot;)</code></pre>
<pre><code>## Warning: Missing column names filled in: &#39;X33&#39; [33]</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_double(),
##   diagnosis = col_character(),
##   X33 = col_character()
## )</code></pre>
<pre><code>## See spec(...) for full column specifications.</code></pre>
<pre><code>## Warning: 569 parsing failures.
## row col   expected     actual                file
##   1  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   2  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   3  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   4  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   5  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
## ... ... .......... .......... ...................
## See problems(...) for more details.</code></pre>
<p>Set Chunk: 0.24 sec elapsed</p>
<p>There is a strange extra column named X33 dealing with that using janitor package</p>
<pre class="r"><code>df &lt;- df %&gt;% 
  janitor::remove_empty_cols()</code></pre>
<pre><code>## Warning: &#39;janitor::remove_empty_cols&#39; é obsoleto.
## Use &#39;remove_empty(&quot;cols&quot;)&#39; em seu lugar
## Veja help(&quot;Deprecated&quot;)</code></pre>
<p>Cleaning Data: 0.02 sec elapsed</p>
</div>
<div id="visualizing-the-data-using-dataexplorer-and-skimr" class="section level1">
<h1>Visualizing the data using DataExplorer and Skimr</h1>
<div id="skimr-is-a-fast-way-to-get-info-on-your-data-even-though-the-hist-plot-fails-on-my-blog" class="section level2">
<h2>Skimr is a fast way to get info on your data even though the hist plot fails on my blog :(</h2>
<pre class="r"><code>df %&gt;% 
  skimr::skim() %&gt;% 
  skimr::kable()</code></pre>
<pre><code>## Skim summary statistics  
##  n obs: 569    
##  n variables: 32    
## 
## Variable type: character
## 
##  variable     missing    complete     n     min    max    empty    n_unique 
## -----------  ---------  ----------  -----  -----  -----  -------  ----------
##  diagnosis       0         569       569     1      1       0         2     
## 
## Variable type: numeric
## 
##         variable            missing    complete     n      mean       sd         p0        p25       p50        p75       p100        hist   
## -------------------------  ---------  ----------  -----  --------  ---------  ---------  --------  --------  ---------  ---------  ----------
##         area_mean              0         569       569    654.89    351.91      143.5     420.3     551.1      782.7      2501      &lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##          area_se               0         569       569    40.34      45.49       6.8      17.85     24.53      45.19      542.2     &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##        area_worst              0         569       569    880.58    569.36      185.2     515.3     686.5      1084       4254      &lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##     compactness_mean           0         569       569     0.1       0.053      0.019     0.065     0.093      0.13       0.35      &lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      compactness_se            0         569       569    0.025      0.018     0.0023     0.013      0.02      0.032      0.14      &lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##     compactness_worst          0         569       569     0.25      0.16       0.027      0.15      0.21      0.34       1.06      &lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##    concave points_mean         0         569       569    0.049      0.039        0        0.02     0.034      0.074       0.2      &lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2583&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##     concave points_se          0         569       569    0.012     0.0062        0       0.0076    0.011      0.015      0.053     &lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##   concave points_worst         0         569       569     0.11      0.066        0       0.065      0.1       0.16       0.29      &lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2585&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2581&gt; 
##      concavity_mean            0         569       569    0.089      0.08         0        0.03     0.062      0.13       0.43      &lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       concavity_se             0         569       569    0.032      0.03         0       0.015     0.026      0.042       0.4      &lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      concavity_worst           0         569       569     0.27      0.21         0        0.11      0.23      0.38       1.25      &lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##  fractal_dimension_mean        0         569       569    0.063     0.0071      0.05      0.058     0.062      0.066      0.097     &lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##   fractal_dimension_se         0         569       569    0.0038    0.0026     0.00089    0.0022    0.0032    0.0046      0.03      &lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##  fractal_dimension_worst       0         569       569    0.084      0.018      0.055     0.071      0.08      0.092      0.21      &lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##            id                  0         569       569    3e+07     1.3e+08     8670      869218    906024    8813129    9.1e+08    &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      perimeter_mean            0         569       569    91.97      24.3       43.79     75.17     86.24      104.1      188.5     &lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       perimeter_se             0         569       569     2.87      2.02       0.76       1.61      2.29      3.36       21.98     &lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      perimeter_worst           0         569       569    107.26     33.6       50.41     84.11     97.66      125.4      251.2     &lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##        radius_mean             0         569       569    14.13      3.52       6.98       11.7     13.37      15.78      28.11     &lt;U+2581&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##         radius_se              0         569       569     0.41      0.28       0.11       0.23      0.32      0.48       2.87      &lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       radius_worst             0         569       569    16.27      4.83       7.93      13.01     14.97      18.79      36.04     &lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      smoothness_mean           0         569       569    0.096      0.014      0.053     0.086     0.096      0.11       0.16      &lt;U+2581&gt;&lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       smoothness_se            0         569       569    0.007      0.003     0.0017     0.0052    0.0064    0.0081      0.031     &lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##     smoothness_worst           0         569       569     0.13      0.023      0.071      0.12      0.13      0.15       0.22      &lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       symmetry_mean            0         569       569     0.18      0.027      0.11       0.16      0.18       0.2        0.3      &lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##        symmetry_se             0         569       569    0.021     0.0083     0.0079     0.015     0.019      0.023      0.079     &lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##      symmetry_worst            0         569       569     0.29      0.062      0.16       0.25      0.28      0.32       0.66      &lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       texture_mean             0         569       569    19.29       4.3       9.71      16.17     18.84      21.8       39.28     &lt;U+2582&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##        texture_se              0         569       569     1.22      0.55       0.36       0.83      1.11      1.47       4.88      &lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt; 
##       texture_worst            0         569       569    25.68      6.15       12.02     21.08     25.41      29.72      49.54     &lt;U+2582&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2585&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;</code></pre>
<p>Skimr: 0.3 sec elapsed</p>
</div>
<div id="data-explorer" class="section level2">
<h2>Data Explorer</h2>
<p>Is a imho a prettier option with individual cool plots and a super powerfull(but slow) report creation tool when working outside of an Rmarkdownm document</p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_intro()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-1.png" width="672" /></p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_bar()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-2.png" width="672" /></p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_correlation()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-3.png" width="672" />Data Explorer individual plots: 1.34 sec elapsed</p>
<p>There are much more amaziong tools such as the <a href="https://www.data-imaginist.com/2019/a-flurry-of-facets/">ggforce package</a> , but I hope you get the gist of the exploration stage.</p>
</div>
</div>
<div id="modeling" class="section level1">
<h1>Modeling</h1>
<p>For now I am going to focus on the tools provided by the tidymodels packages and the KNN, in the future I may come back to add more models and probably to play around the DALEX package a little bit.</p>
<p>Just to remember M is Malignant and B is Benign, we are trying to correcly classify our patients, I am going to ignore the id Varible since it should not be reliaded upon to generate predictions(Even though it may capture some interesting effects such as better screening for patients on the latter id’s).</p>
<div id="train-test-split" class="section level2">
<h2>Train Test Split</h2>
<p>Usually we split our data into training and test data to ensure a fair evaluation of the models or parameters being tested(hoping to avoid overfitting).</p>
<p>The workflow for the tidymodels is that we first split our data.</p>
<pre class="r"><code>df_split &lt;- df %&gt;% 
  rsample::initial_split(prop = 0.8)
df_split</code></pre>
<pre><code>## &lt;456/113/569&gt;</code></pre>
<p>unnamed-chunk-1: 0.01 sec elapsed</p>
<p>Then we model on our Training Data</p>
</div>
<div id="recipes" class="section level2">
<h2>Recipes</h2>
<p>Recipes are used to preprocess our data, the main mistake here is using the whole data set.</p>
<p>The recipe package helps us with this process.</p>
<p>For those not familearized with the formula notation I am fitting the model on all variables except the id variable.</p>
<p>I am than Normalizing my data since the KNN alghoritm is sensible to the scale of the variables being used, I am also excluding variables with high absolute correlation amongst themselves.</p>
<p>Recipes are easy to read and can be quite complex for example I could scale all predictor that are numeric on</p>
<pre class="r"><code>df_recipe &lt;- training(df_split) %&gt;% 
  recipe(diagnosis ~ .-id) %&gt;% 
  step_center(all_predictors()) %&gt;% 
  step_scale(all_predictors(),all_numeric()) %&gt;% 
  step_corr(all_predictors()) %&gt;% 
  prep()
df_recipe</code></pre>
<pre><code>## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor         31
## 
## Training data contained 456 data points and no missing data.
## 
## Operations:
## 
## Centering for id, radius_mean, ... [trained]
## Scaling for id, radius_mean, ... [trained]
## Correlation filter removed perimeter_mean, ... [trained]</code></pre>
<p>unnamed-chunk-2: 0.08 sec elapsed</p>
<p>We can then create our train and test data frames by baking our recipe and juicing our recipe</p>
<pre class="r"><code>df_testing &lt;- df_recipe %&gt;% 
  bake(testing(df_split))
df_testing</code></pre>
<pre><code>## # A tibble: 113 x 22
##        id diagnosis radius_mean texture_mean smoothness_mean
##     &lt;dbl&gt; &lt;fct&gt;           &lt;dbl&gt;        &lt;dbl&gt;           &lt;dbl&gt;
##  1 -0.234 M               1.11        -2.13          1.57   
##  2 -0.234 M               1.84        -0.370        -0.808  
##  3 -0.234 M              -0.308        0.596         2.20   
##  4  0.427 M               0.480       -0.341         0.0652 
##  5 -0.234 M               0.500        1.10         -0.860  
##  6 -0.234 M               0.168        0.193         0.176  
##  7 -0.174 B              -1.30        -1.64          0.440  
##  8 -0.234 M               0.866       -0.696         1.58   
##  9 -0.234 M               0.753        0.541        -0.00541
## 10 -0.234 B              -0.300       -0.215        -0.448  
## # ... with 103 more rows, and 17 more variables: compactness_mean &lt;dbl&gt;,
## #   symmetry_mean &lt;dbl&gt;, fractal_dimension_mean &lt;dbl&gt;, texture_se &lt;dbl&gt;,
## #   area_se &lt;dbl&gt;, smoothness_se &lt;dbl&gt;, compactness_se &lt;dbl&gt;,
## #   concavity_se &lt;dbl&gt;, `concave points_se` &lt;dbl&gt;, symmetry_se &lt;dbl&gt;,
## #   fractal_dimension_se &lt;dbl&gt;, smoothness_worst &lt;dbl&gt;,
## #   compactness_worst &lt;dbl&gt;, concavity_worst &lt;dbl&gt;, `concave
## #   points_worst` &lt;dbl&gt;, symmetry_worst &lt;dbl&gt;,
## #   fractal_dimension_worst &lt;dbl&gt;</code></pre>
<p>unnamed-chunk-3: 0.08 sec elapsed</p>
<pre class="r"><code>df_training &lt;- juice(df_recipe)</code></pre>
<p>unnamed-chunk-4: 0.01 sec elapsed</p>
</div>
<div id="cross-validation-and-random-serch" class="section level2">
<h2>Cross Validation and Random Serch</h2>
<div id="cross-validation" class="section level3">
<h3>Cross Validation</h3>
<p>We further divide our data frame into folds in order to improve our certainty that the ideal number of neighbours is right.</p>
<pre class="r"><code>df_cross_testing &lt;- df_testing %&gt;% vfold_cv(v = 10)</code></pre>
<p>unnamed-chunk-5: 0 sec elapsed</p>
<p>To decide the KNN parameters we could use the Dials package, grid searchign neighbors 1 to 50, Working on this</p>
<pre class="r"><code>bst_grid &lt;- grid_random(
  neighbors %&gt;%  range_set(c( 1,  50)), 
  size = 10
)</code></pre>
<p>unnamed-chunk-6: 0.01 sec elapsed</p>
<pre class="r"><code>nearest_neighbor_model &lt;- parsnip::nearest_neighbor(mode = &quot;classification&quot;) %&gt;% 
  set_engine(&quot;kknn&quot;) %&gt;%
  merge(bst_grid)</code></pre>
<p>unnamed-chunk-7: 0.02 sec elapsed</p>
<pre class="r"><code>results_cross_validation &lt;- crossing(df_cross_testing,nearest_neighbor_model) </code></pre>
<p>unnamed-chunk-8: 0.01 sec elapsed</p>
</div>
</div>
</div>
