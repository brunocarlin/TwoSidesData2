---
title: Classification - KNN
authors: 
- admin
date: '2019-08-15'
slug: classification-knn
categories:
  - r-project
tags:
  - tidyverse
  - tidymodels
image:
  caption: ''
  focal_point: ''
output: 
  html_document:
    toc: true
    toc_float:
      toc_collapsed: true
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<p>Breast Cancer problem.</p>
<p>This is a problem that I have trid to solve using just the old tidymodels package and got stuck so here is the new implementation using the amazing tune and workflows
packages</p>
<div id="setting-up-rmarkdown" class="section level1">
<h1>Setting up Rmarkdown</h1>
<p>root.dir =</p>
</div>
<div id="loading-libraries" class="section level1">
<h1>Loading Libraries</h1>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages ------------------------------------------ tidyverse 1.3.0 --</code></pre>
<pre><code>## &lt;U+2713&gt; ggplot2 3.2.1     &lt;U+2713&gt; purrr   0.3.3
## &lt;U+2713&gt; tibble  2.1.3     &lt;U+2713&gt; dplyr   0.8.3
## &lt;U+2713&gt; tidyr   1.0.0     &lt;U+2713&gt; stringr 1.4.0
## &lt;U+2713&gt; readr   1.3.1     &lt;U+2713&gt; forcats 0.4.0</code></pre>
<pre><code>## -- Conflicts --------------------------------------------- tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(tidymodels)</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;xts&#39;:
##   method     from
##   as.zoo.xts zoo</code></pre>
<pre><code>## -- Attaching packages ----------------------------------------- tidymodels 0.0.3 --</code></pre>
<pre><code>## &lt;U+2713&gt; broom     0.5.3     &lt;U+2713&gt; recipes   0.1.8
## &lt;U+2713&gt; dials     0.0.4     &lt;U+2713&gt; rsample   0.0.5
## &lt;U+2713&gt; infer     0.5.1     &lt;U+2713&gt; yardstick 0.0.4
## &lt;U+2713&gt; parsnip   0.0.4</code></pre>
<pre><code>## -- Conflicts -------------------------------------------- tidymodels_conflicts() --
## x scales::discard()   masks purrr::discard()
## x dplyr::filter()     masks stats::filter()
## x recipes::fixed()    masks stringr::fixed()
## x dplyr::lag()        masks stats::lag()
## x dials::margin()     masks ggplot2::margin()
## x yardstick::spec()   masks readr::spec()
## x recipes::step()     masks stats::step()
## x recipes::yj_trans() masks scales::yj_trans()</code></pre>
<pre class="r"><code>library(janitor)</code></pre>
<pre><code>## 
## Attaching package: &#39;janitor&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     chisq.test, fisher.test</code></pre>
<pre class="r"><code>library(skimr)
library(DataExplorer)</code></pre>
<p>Loading Libraries: 3.64 sec elapsed</p>
</div>
<div id="getting-data" class="section level1">
<h1>Getting Data</h1>
<p>Got the dataset with headers on <a href="https://www.kaggle.com/uciml/breast-cancer-wisconsin-data/version/2">kaggle link</a>, there is also a cool explanation about the problem there.</p>
<pre class="r"><code>df &lt;- read_csv(&quot;breast_cancer.csv&quot;)</code></pre>
<pre><code>## Warning: Missing column names filled in: &#39;X33&#39; [33]</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_double(),
##   diagnosis = col_character(),
##   X33 = col_character()
## )</code></pre>
<pre><code>## See spec(...) for full column specifications.</code></pre>
<pre><code>## Warning: 569 parsing failures.
## row col   expected     actual                file
##   1  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   2  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   3  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   4  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
##   5  -- 33 columns 32 columns &#39;breast_cancer.csv&#39;
## ... ... .......... .......... ...................
## See problems(...) for more details.</code></pre>
<p>Set Chunk: 0.15 sec elapsed</p>
<p>There is a strange extra column named X33 dealing with that using janitor package</p>
<pre class="r"><code>df &lt;- df %&gt;% 
  janitor::remove_empty_cols()</code></pre>
<pre><code>## Warning: &#39;janitor::remove_empty_cols&#39; is deprecated.
## Use &#39;remove_empty(&quot;cols&quot;)&#39; instead.
## See help(&quot;Deprecated&quot;)</code></pre>
<p>Cleaning Data: 0 sec elapsed</p>
</div>
<div id="visualizing-the-data-using-dataexplorer-and-skimr" class="section level1">
<h1>Visualizing the data using DataExplorer and Skimr</h1>
<div id="skimr-is-a-fast-way-to-get-info-on-your-data-even-though-the-hist-plot-fails-on-my-blog" class="section level2">
<h2>Skimr is a fast way to get info on your data even though the hist plot fails on my blog :(</h2>
<pre class="r"><code>df %&gt;% 
  skimr::skim()</code></pre>
<table>
<caption><span id="tab:Skimr">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">Piped data</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">569</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">32</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">31</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">diagnosis</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">id</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">30371831.43</td>
<td align="right">125020585.61</td>
<td align="right">8670.00</td>
<td align="right">869218.00</td>
<td align="right">906024.00</td>
<td align="right">8813129.00</td>
<td align="right">911320502.00</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">radius_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">14.13</td>
<td align="right">3.52</td>
<td align="right">6.98</td>
<td align="right">11.70</td>
<td align="right">13.37</td>
<td align="right">15.78</td>
<td align="right">28.11</td>
<td align="left">▂▇▃▁▁</td>
</tr>
<tr class="odd">
<td align="left">texture_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">19.29</td>
<td align="right">4.30</td>
<td align="right">9.71</td>
<td align="right">16.17</td>
<td align="right">18.84</td>
<td align="right">21.80</td>
<td align="right">39.28</td>
<td align="left">▃▇▃▁▁</td>
</tr>
<tr class="even">
<td align="left">perimeter_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">91.97</td>
<td align="right">24.30</td>
<td align="right">43.79</td>
<td align="right">75.17</td>
<td align="right">86.24</td>
<td align="right">104.10</td>
<td align="right">188.50</td>
<td align="left">▃▇▃▁▁</td>
</tr>
<tr class="odd">
<td align="left">area_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">654.89</td>
<td align="right">351.91</td>
<td align="right">143.50</td>
<td align="right">420.30</td>
<td align="right">551.10</td>
<td align="right">782.70</td>
<td align="right">2501.00</td>
<td align="left">▇▃▂▁▁</td>
</tr>
<tr class="even">
<td align="left">smoothness_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.10</td>
<td align="right">0.01</td>
<td align="right">0.05</td>
<td align="right">0.09</td>
<td align="right">0.10</td>
<td align="right">0.11</td>
<td align="right">0.16</td>
<td align="left">▁▇▇▁▁</td>
</tr>
<tr class="odd">
<td align="left">compactness_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.10</td>
<td align="right">0.05</td>
<td align="right">0.02</td>
<td align="right">0.06</td>
<td align="right">0.09</td>
<td align="right">0.13</td>
<td align="right">0.35</td>
<td align="left">▇▇▂▁▁</td>
</tr>
<tr class="even">
<td align="left">concavity_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.09</td>
<td align="right">0.08</td>
<td align="right">0.00</td>
<td align="right">0.03</td>
<td align="right">0.06</td>
<td align="right">0.13</td>
<td align="right">0.43</td>
<td align="left">▇▃▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">concave points_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.05</td>
<td align="right">0.04</td>
<td align="right">0.00</td>
<td align="right">0.02</td>
<td align="right">0.03</td>
<td align="right">0.07</td>
<td align="right">0.20</td>
<td align="left">▇▃▂▁▁</td>
</tr>
<tr class="even">
<td align="left">symmetry_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.18</td>
<td align="right">0.03</td>
<td align="right">0.11</td>
<td align="right">0.16</td>
<td align="right">0.18</td>
<td align="right">0.20</td>
<td align="right">0.30</td>
<td align="left">▁▇▅▁▁</td>
</tr>
<tr class="odd">
<td align="left">fractal_dimension_mean</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.06</td>
<td align="right">0.01</td>
<td align="right">0.05</td>
<td align="right">0.06</td>
<td align="right">0.06</td>
<td align="right">0.07</td>
<td align="right">0.10</td>
<td align="left">▆▇▂▁▁</td>
</tr>
<tr class="even">
<td align="left">radius_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.41</td>
<td align="right">0.28</td>
<td align="right">0.11</td>
<td align="right">0.23</td>
<td align="right">0.32</td>
<td align="right">0.48</td>
<td align="right">2.87</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">texture_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1.22</td>
<td align="right">0.55</td>
<td align="right">0.36</td>
<td align="right">0.83</td>
<td align="right">1.11</td>
<td align="right">1.47</td>
<td align="right">4.88</td>
<td align="left">▇▅▁▁▁</td>
</tr>
<tr class="even">
<td align="left">perimeter_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2.87</td>
<td align="right">2.02</td>
<td align="right">0.76</td>
<td align="right">1.61</td>
<td align="right">2.29</td>
<td align="right">3.36</td>
<td align="right">21.98</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">area_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">40.34</td>
<td align="right">45.49</td>
<td align="right">6.80</td>
<td align="right">17.85</td>
<td align="right">24.53</td>
<td align="right">45.19</td>
<td align="right">542.20</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">smoothness_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.01</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.03</td>
<td align="left">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">compactness_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.03</td>
<td align="right">0.02</td>
<td align="right">0.00</td>
<td align="right">0.01</td>
<td align="right">0.02</td>
<td align="right">0.03</td>
<td align="right">0.14</td>
<td align="left">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td align="left">concavity_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.03</td>
<td align="right">0.03</td>
<td align="right">0.00</td>
<td align="right">0.02</td>
<td align="right">0.03</td>
<td align="right">0.04</td>
<td align="right">0.40</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">concave points_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.00</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.05</td>
<td align="left">▇▇▁▁▁</td>
</tr>
<tr class="even">
<td align="left">symmetry_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.02</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
<td align="right">0.02</td>
<td align="right">0.02</td>
<td align="right">0.02</td>
<td align="right">0.08</td>
<td align="left">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">fractal_dimension_se</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.03</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">radius_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">16.27</td>
<td align="right">4.83</td>
<td align="right">7.93</td>
<td align="right">13.01</td>
<td align="right">14.97</td>
<td align="right">18.79</td>
<td align="right">36.04</td>
<td align="left">▆▇▃▁▁</td>
</tr>
<tr class="odd">
<td align="left">texture_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">25.68</td>
<td align="right">6.15</td>
<td align="right">12.02</td>
<td align="right">21.08</td>
<td align="right">25.41</td>
<td align="right">29.72</td>
<td align="right">49.54</td>
<td align="left">▃▇▆▁▁</td>
</tr>
<tr class="even">
<td align="left">perimeter_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">107.26</td>
<td align="right">33.60</td>
<td align="right">50.41</td>
<td align="right">84.11</td>
<td align="right">97.66</td>
<td align="right">125.40</td>
<td align="right">251.20</td>
<td align="left">▇▇▃▁▁</td>
</tr>
<tr class="odd">
<td align="left">area_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">880.58</td>
<td align="right">569.36</td>
<td align="right">185.20</td>
<td align="right">515.30</td>
<td align="right">686.50</td>
<td align="right">1084.00</td>
<td align="right">4254.00</td>
<td align="left">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td align="left">smoothness_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.13</td>
<td align="right">0.02</td>
<td align="right">0.07</td>
<td align="right">0.12</td>
<td align="right">0.13</td>
<td align="right">0.15</td>
<td align="right">0.22</td>
<td align="left">▂▇▇▂▁</td>
</tr>
<tr class="odd">
<td align="left">compactness_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.25</td>
<td align="right">0.16</td>
<td align="right">0.03</td>
<td align="right">0.15</td>
<td align="right">0.21</td>
<td align="right">0.34</td>
<td align="right">1.06</td>
<td align="left">▇▅▁▁▁</td>
</tr>
<tr class="even">
<td align="left">concavity_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.27</td>
<td align="right">0.21</td>
<td align="right">0.00</td>
<td align="right">0.11</td>
<td align="right">0.23</td>
<td align="right">0.38</td>
<td align="right">1.25</td>
<td align="left">▇▅▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">concave points_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.11</td>
<td align="right">0.07</td>
<td align="right">0.00</td>
<td align="right">0.06</td>
<td align="right">0.10</td>
<td align="right">0.16</td>
<td align="right">0.29</td>
<td align="left">▅▇▅▃▁</td>
</tr>
<tr class="even">
<td align="left">symmetry_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.29</td>
<td align="right">0.06</td>
<td align="right">0.16</td>
<td align="right">0.25</td>
<td align="right">0.28</td>
<td align="right">0.32</td>
<td align="right">0.66</td>
<td align="left">▅▇▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">fractal_dimension_worst</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.08</td>
<td align="right">0.02</td>
<td align="right">0.06</td>
<td align="right">0.07</td>
<td align="right">0.08</td>
<td align="right">0.09</td>
<td align="right">0.21</td>
<td align="left">▇▃▁▁▁</td>
</tr>
</tbody>
</table>
<p>Skimr: 0.16 sec elapsed</p>
</div>
<div id="data-explorer" class="section level2">
<h2>Data Explorer</h2>
<p>Is a imho a prettier option with individual cool plots and a super powerfull(but slow) report creation tool when working outside of an Rmarkdownm document</p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_intro()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-1.png" width="672" /></p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_bar()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-2.png" width="672" /></p>
<pre class="r"><code>df %&gt;% 
  DataExplorer::plot_correlation()</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/Data%20Explorer%20%20individual%20plots-3.png" width="672" />Data Explorer individual plots: 1 sec elapsed</p>
<p>There are much more amaziong tools such as the <a href="https://www.data-imaginist.com/2019/a-flurry-of-facets/">ggforce package</a> , but I hope you get the gist of the exploration stage.</p>
</div>
</div>
<div id="modeling" class="section level1">
<h1>Modeling</h1>
<p>For now I am going to focus on the tools provided by the tidymodels packages and the KNN, in the future I may come back to add more models and probably to play around the DALEX package a little bit.</p>
<p>Just to remember M is Malignant and B is Benign, we are trying to correcly classify our patients, I am going to ignore the id Varible since it should not be reliaded upon to generate predictions(Even though it may capture some interesting effects such as better screening for patients on the latter id’s).</p>
<div id="train-test-split" class="section level2">
<h2>Train Test Split</h2>
<p>Usually we split our data into training and test data to ensure a fair evaluation of the models or parameters being tested(hoping to avoid overfitting).</p>
<p>The workflow for the tidymodels is that we first split our data.</p>
<pre class="r"><code>df_split &lt;- df %&gt;% 
  rsample::initial_split(prop = 0.8)</code></pre>
<p>Initial Split: 0 sec elapsed</p>
<pre class="r"><code>df_training &lt;- df_split %&gt;% training()
df_testing &lt;- df_split %&gt;% testing()</code></pre>
<p>Train test split: 0 sec elapsed</p>
<p>Then we model on our Training Data</p>
</div>
<div id="recipes" class="section level2">
<h2>Recipes</h2>
<p>Recipes are used to preprocess our data, the main mistake here is using the whole data set.</p>
<p>The recipe package helps us with this process.</p>
<p>For those not familiarized with the formula notation I am fitting the model on all variables except the id variable.</p>
<p>I am than Normalizing my data since the KNN alghoritm is sensible to the scale of the variables being used, I am also excluding variables with high absolute correlation amongst themselves.</p>
<p>Recipes are easy to read and can be quite complex</p>
<pre class="r"><code>df_recipe &lt;- training(df_split) %&gt;% 
  recipe(diagnosis ~ .) %&gt;%
  step_rm(id) %&gt;% 
  step_center(all_predictors()) %&gt;% 
  step_scale(all_predictors(),all_numeric()) %&gt;% 
  step_corr(all_predictors())</code></pre>
<p>recipes: 0.02 sec elapsed</p>
<p>We could then create our train and test data frames by baking our recipe and juicing our recipe</p>
<pre class="r"><code># df_testing &lt;- df_recipe %&gt;% 
#   bake(testing(df_split))
# df_testing
#df_training &lt;- juice(df_recipe)</code></pre>
<p>unnamed-chunk-1: 0 sec elapsed</p>
<p>But I am going for a Bayes search approch</p>
</div>
<div id="cross-validation-and-bayes-search" class="section level2">
<h2>Cross Validation and Bayes Search</h2>
<div id="cross-validation" class="section level3">
<h3>Cross Validation</h3>
<p>We further divide our data frame into folds in order to improve our certainty that the ideal number of neighbours is right.</p>
<pre class="r"><code>cv_splits &lt;- df_testing %&gt;% vfold_cv(v = 5)</code></pre>
<p>cvfold split: 0 sec elapsed</p>
</div>
<div id="using-the-new-tune-package-currently-on-github" class="section level3">
<h3>Using the new tune package currently on github</h3>
<pre class="r"><code>library(tune)
knn_mod &lt;- 
  nearest_neighbor(neighbors = tune(), weight_func = tune()) %&gt;% 
  set_engine(&quot;kknn&quot;) %&gt;% 
  set_mode(&quot;classification&quot;)</code></pre>
<p>unnamed-chunk-2: 0.05 sec elapsed</p>
</div>
<div id="combining-everything-so-far-in-the-new-package-workflow" class="section level3">
<h3>Combining everything so far in the new package workflow</h3>
<pre class="r"><code>library(workflows)
knn_wflow &lt;- 
  workflow() %&gt;% 
  add_model(knn_mod) %&gt;% 
  add_recipe(df_recipe)</code></pre>
<p>unnamed-chunk-3: 0.04 sec elapsed</p>
</div>
<div id="limiting-our-search" class="section level3">
<h3>Limiting our search</h3>
<pre class="r"><code>knn_param &lt;- 
  knn_wflow %&gt;% 
  parameters() %&gt;% 
    update(
    neighbors = neighbors(c(3, 50)),
    weight_func = weight_func(values = c(&quot;rectangular&quot;, &quot;inv&quot;, &quot;gaussian&quot;, &quot;triangular&quot;))
  )</code></pre>
<p>unnamed-chunk-4: 0.03 sec elapsed</p>
</div>
<div id="searching-for-the-best-model" class="section level3">
<h3>Searching for the best model</h3>
<p>I used 5 iterations as the limit for the process because of printing reasons.</p>
<p>Keep in mind that mtune will maximize just the first metric from the package yardstick</p>
<pre class="r"><code>ctrl &lt;- control_bayes(verbose = TRUE,no_improve = 5)
set.seed(42)
knn_search &lt;- tune_bayes(knn_wflow,
                         resamples = cv_splits,
                         initial = 5,
                         iter = 20,
                         param_info = knn_param,
                         control = ctrl,
                         metrics = metric_set(roc_auc,accuracy))</code></pre>
<pre><code>## </code></pre>
<pre><code>## &gt;  Generating a set of 5 initial parameter results</code></pre>
<pre><code>## v Initialization complete</code></pre>
<pre><code>## </code></pre>
<pre><code>## Optimizing roc_auc using the expected improvement</code></pre>
<pre><code>## </code></pre>
<pre><code>## -- Iteration 1 --------------------------------------------------------------------</code></pre>
<pre><code>## </code></pre>
<pre><code>## i Current best:      roc_auc=0.9853 (@iter 0)</code></pre>
<pre><code>## i Gaussian process model</code></pre>
<pre><code>## v Gaussian process model</code></pre>
<pre><code>## i Generating 139 candidates</code></pre>
<pre><code>## i Predicted candidates</code></pre>
<pre><code>## i neighbors=3, weight_func=rectangular</code></pre>
<pre><code>## i Estimating performance</code></pre>
<pre><code>## v Estimating performance</code></pre>
<pre><code>## &lt;U+24E7&gt; Newest results: roc_auc=0.9543 (+/-0.0187)</code></pre>
<pre><code>## </code></pre>
<pre><code>## -- Iteration 2 --------------------------------------------------------------------</code></pre>
<pre><code>## </code></pre>
<pre><code>## i Current best:      roc_auc=0.9853 (@iter 0)</code></pre>
<pre><code>## i Gaussian process model</code></pre>
<pre><code>## v Gaussian process model</code></pre>
<pre><code>## i Generating 138 candidates</code></pre>
<pre><code>## i Predicted candidates</code></pre>
<pre><code>## i neighbors=50, weight_func=inv</code></pre>
<pre><code>## i Estimating performance</code></pre>
<pre><code>## v Estimating performance</code></pre>
<pre><code>## &lt;U+24E7&gt; Newest results: roc_auc=0.9818 (+/-0.00511)</code></pre>
<pre><code>## </code></pre>
<pre><code>## -- Iteration 3 --------------------------------------------------------------------</code></pre>
<pre><code>## </code></pre>
<pre><code>## i Current best:      roc_auc=0.9853 (@iter 0)</code></pre>
<pre><code>## i Gaussian process model</code></pre>
<pre><code>## v Gaussian process model</code></pre>
<pre><code>## i Generating 137 candidates</code></pre>
<pre><code>## i Predicted candidates</code></pre>
<pre><code>## i neighbors=50, weight_func=rectangular</code></pre>
<pre><code>## i Estimating performance</code></pre>
<pre><code>## v Estimating performance</code></pre>
<pre><code>## &lt;U+24E7&gt; Newest results: roc_auc=0.9747 (+/-0.00777)</code></pre>
<pre><code>## </code></pre>
<pre><code>## -- Iteration 4 --------------------------------------------------------------------</code></pre>
<pre><code>## </code></pre>
<pre><code>## i Current best:      roc_auc=0.9853 (@iter 0)</code></pre>
<pre><code>## i Gaussian process model</code></pre>
<pre><code>## v Gaussian process model</code></pre>
<pre><code>## i Generating 136 candidates</code></pre>
<pre><code>## i Predicted candidates</code></pre>
<pre><code>## i neighbors=15, weight_func=rectangular</code></pre>
<pre><code>## i Estimating performance</code></pre>
<pre><code>## v Estimating performance</code></pre>
<pre><code>## &lt;U+24E7&gt; Newest results: roc_auc=0.9771 (+/-0.00521)</code></pre>
<pre><code>## </code></pre>
<pre><code>## -- Iteration 5 --------------------------------------------------------------------</code></pre>
<pre><code>## </code></pre>
<pre><code>## i Current best:      roc_auc=0.9853 (@iter 0)</code></pre>
<pre><code>## i Gaussian process model</code></pre>
<pre><code>## v Gaussian process model</code></pre>
<pre><code>## i Generating 135 candidates</code></pre>
<pre><code>## i Predicted candidates</code></pre>
<pre><code>## i neighbors=39, weight_func=rectangular</code></pre>
<pre><code>## i Estimating performance</code></pre>
<pre><code>## v Estimating performance</code></pre>
<pre><code>## &lt;U+24E7&gt; Newest results: roc_auc=0.9741 (+/-0.00684)</code></pre>
<pre><code>## ! No improvement for 5 iterations; returning current results.</code></pre>
<p>Bayes Search: 26.1 sec elapsed</p>
</div>
<div id="visualizing-our-search" class="section level3">
<h3>Visualizing our search</h3>
<pre class="r"><code>autoplot(knn_search, type = &quot;performance&quot;, metric = &quot;accuracy&quot;)</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/unnamed-chunk-5-1.png" width="672" />unnamed-chunk-5: 0.16 sec elapsed</p>
<pre class="r"><code>autoplot(knn_search, type = &quot;performance&quot;, metric = &quot;roc_auc&quot;)</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/unnamed-chunk-6-1.png" width="672" />unnamed-chunk-6: 0.18 sec elapsed</p>
</div>
<div id="seing-the-best-result" class="section level3">
<h3>Seing the best result</h3>
<pre class="r"><code>collect_metrics(knn_search) %&gt;% 
  dplyr::filter(.metric == &quot;accuracy&quot;) %&gt;% 
  arrange(mean %&gt;% desc)</code></pre>
<pre><code>## # A tibble: 10 x 8
##    neighbors weight_func .iter .metric  .estimator  mean     n std_err
##        &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
##  1         5 inv             0 accuracy binary     0.939     5 0.0221 
##  2         3 rectangular     1 accuracy binary     0.921     5 0.0287 
##  3        13 inv             0 accuracy binary     0.921     5 0.00853
##  4        15 rectangular     4 accuracy binary     0.903     5 0.0166 
##  5        42 gaussian        0 accuracy binary     0.894     5 0.0175 
##  6        33 inv             0 accuracy binary     0.868     5 0.0305 
##  7        27 rectangular     0 accuracy binary     0.858     5 0.0357 
##  8        39 rectangular     5 accuracy binary     0.780     5 0.0458 
##  9        50 inv             2 accuracy binary     0.772     5 0.0518 
## 10        50 rectangular     3 accuracy binary     0.718     5 0.0464</code></pre>
<p>unnamed-chunk-7: 0.04 sec elapsed</p>
<pre class="r"><code>collect_metrics(knn_search) %&gt;% 
  dplyr::filter(.metric == &quot;roc_auc&quot;) %&gt;% 
  arrange(mean %&gt;% desc)</code></pre>
<pre><code>## # A tibble: 10 x 8
##    neighbors weight_func .iter .metric .estimator  mean     n std_err
##        &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
##  1        13 inv             0 roc_auc binary     0.985     5 0.00629
##  2         5 inv             0 roc_auc binary     0.984     5 0.00737
##  3        50 inv             2 roc_auc binary     0.982     5 0.00511
##  4        42 gaussian        0 roc_auc binary     0.980     5 0.00575
##  5        33 inv             0 roc_auc binary     0.978     5 0.00599
##  6        15 rectangular     4 roc_auc binary     0.977     5 0.00521
##  7        50 rectangular     3 roc_auc binary     0.975     5 0.00777
##  8        39 rectangular     5 roc_auc binary     0.974     5 0.00684
##  9        27 rectangular     0 roc_auc binary     0.973     5 0.00803
## 10         3 rectangular     1 roc_auc binary     0.954     5 0.0187</code></pre>
<p>unnamed-chunk-8: 0.03 sec elapsed</p>
</div>
<div id="extracting-the-best-model" class="section level3">
<h3>Extracting the best model</h3>
<pre class="r"><code>best_metrics &lt;- collect_metrics(knn_search) %&gt;% 
  dplyr::filter(.metric == &quot;roc_auc&quot;) %&gt;% 
  arrange(mean %&gt;% desc) %&gt;% 
  head(1) %&gt;% 
  select(neighbors,weight_func) %&gt;% 
  as.list()</code></pre>
<p>unnamed-chunk-9: 0.01 sec elapsed</p>
</div>
<div id="creating-production-model" class="section level3">
<h3>Creating production model</h3>
<pre class="r"><code>production_knn &lt;-  
  nearest_neighbor(neighbors = best_metrics$neighbors,weight_func = best_metrics$weight_func) %&gt;% 
  set_engine(&quot;kknn&quot;) %&gt;% 
  set_mode(&quot;classification&quot;)</code></pre>
<p>unnamed-chunk-10: 0 sec elapsed</p>
</div>
<div id="creating-production-wflow" class="section level3">
<h3>Creating production wflow</h3>
<pre class="r"><code>production_wflow &lt;-   workflow() %&gt;% 
  add_model(production_knn) %&gt;% 
  add_recipe(df_recipe)</code></pre>
<p>unnamed-chunk-11: 0 sec elapsed</p>
</div>
<div id="finally-applying-testing-production-model" class="section level3">
<h3>Finally applying testing production model</h3>
<pre class="r"><code>fit_prod &lt;- fit(production_wflow,df_training)</code></pre>
<p>Fitting production: 0.28 sec elapsed</p>
</div>
<div id="metrics" class="section level3">
<h3>Metrics</h3>
<pre class="r"><code>fit_prod %&gt;% predict(df_testing) %&gt;% 
  bind_cols(df_testing %&gt;% transmute(diagnosis = diagnosis %&gt;% as.factor())) %&gt;% 
  yardstick::metrics(truth = diagnosis,estimate = .pred_class)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.947
## 2 kap      binary         0.878</code></pre>
<p>Calculating metrics: 0.03 sec elapsed</p>
<pre class="r"><code>predict(fit_prod,df_testing,type = &#39;prob&#39;) %&gt;%
  bind_cols(df_testing %&gt;% transmute(diagnosis = diagnosis %&gt;% as.factor())) %&gt;% 
  yardstick::roc_auc(truth = diagnosis,.pred_B)</code></pre>
<pre><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 roc_auc binary         0.984</code></pre>
<p>Calculating metrics auc: 0.03 sec elapsed</p>
</div>
</div>
<div id="another-visualization" class="section level2">
<h2>Another visualization</h2>
<pre class="r"><code>knn_naive &lt;- 
  nearest_neighbor(neighbors = tune()) %&gt;% 
  set_engine(&quot;kknn&quot;) %&gt;% 
  set_mode(&quot;classification&quot;)</code></pre>
<p>unnamed-chunk-12: 0 sec elapsed</p>
<div id="combining-everything-so-far-in-the-new-package-workflow-1" class="section level3">
<h3>Combining everything so far in the new package workflow</h3>
<pre class="r"><code>knn_wflow_naive &lt;- 
  workflow() %&gt;% 
  add_model(knn_naive) %&gt;% 
  add_recipe(df_recipe)</code></pre>
<p>unnamed-chunk-13: 0.01 sec elapsed</p>
<pre class="r"><code>knn_naive_param &lt;- 
  knn_wflow %&gt;% 
  parameters() %&gt;% 
    update(
    neighbors = neighbors(c(10, 50))
  )</code></pre>
<p>unnamed-chunk-14: 0.01 sec elapsed</p>
<p>One advantage of the naive search is that it is easy to parallelize</p>
<pre class="r"><code>all_cores &lt;- parallel::detectCores(logical = FALSE)

library(doParallel)</code></pre>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## 
## Attaching package: &#39;foreach&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:purrr&#39;:
## 
##     accumulate, when</code></pre>
<pre><code>## Loading required package: iterators</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre class="r"><code>cl &lt;- makePSOCKcluster(all_cores)
registerDoParallel(cl)</code></pre>
<p>set up parallel: 1.28 sec elapsed</p>
<pre class="r"><code>ctrl &lt;- control_grid(verbose = FALSE)
set.seed(42)
naive_search &lt;- tune_grid(knn_wflow_naive,
                         resamples = cv_splits,
                         param_info = knn_naive_param,
                         control = ctrl,
                         grid = 50,
                         metrics = metric_set(roc_auc,accuracy))</code></pre>
<p>naive grid search: 6.25 sec elapsed</p>
<pre class="r"><code>best_naive_metrics &lt;- collect_metrics(naive_search) %&gt;% 
  dplyr::filter(.metric == &quot;roc_auc&quot;) %&gt;% 
  arrange(mean %&gt;% desc)
DT::datatable(best_naive_metrics,options = list(pageLength = 5, scrollX=T))</code></pre>
<p><div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37"],[28,29,30,31,32,12,13,14,15,17,18,20,21,22,23,24,25,26,11,16,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,10],["roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc","roc_auc"],["binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary","binary"],[0.985592185592186,0.985592185592186,0.985592185592186,0.985592185592186,0.985592185592186,0.984053724053724,0.984053724053724,0.984053724053724,0.984053724053724,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.983687423687424,0.982148962148962,0.982148962148962,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.982083413662361,0.980610500610501],[10,5,10,5,10,5,5,10,5,5,10,10,5,10,5,5,5,10,5,5,10,5,5,5,10,5,5,5,10,5,5,5,10,5,5,10,5],[0.00473129876824046,0.00709694815236069,0.00473129876824046,0.00709694815236069,0.00473129876824046,0.0080820320387894,0.0080820320387894,0.00538802135919293,0.0080820320387894,0.00702448274026395,0.0046829884935093,0.0046829884935093,0.00702448274026395,0.0046829884935093,0.00702448274026395,0.00702448274026395,0.00702448274026395,0.0046829884935093,0.00792658344444738,0.00792658344444738,0.0040771060624849,0.00611565909372735,0.00611565909372735,0.00611565909372735,0.0040771060624849,0.00611565909372735,0.00611565909372735,0.00611565909372735,0.0040771060624849,0.00611565909372735,0.00611565909372735,0.00611565909372735,0.0040771060624849,0.00611565909372735,0.00611565909372735,0.0040771060624849,0.00900287844225165]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>neighbors<\/th>\n      <th>.metric<\/th>\n      <th>.estimator<\/th>\n      <th>mean<\/th>\n      <th>n<\/th>\n      <th>std_err<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>unnamed-chunk-15: 0.04 sec elapsed</p>
<pre class="r"><code>p &lt;- best_naive_metrics %&gt;% 
  ggplot() +
  aes(neighbors,mean) +
  geom_point() +
  ylim(.95,1)
p</code></pre>
<p><img src="/post/2019/08/15/index_files/figure-html/unnamed-chunk-16-1.png" width="672" />unnamed-chunk-16: 0.14 sec elapsed</p>
</div>
</div>
</div>
<div id="checking-the-timing-table" class="section level1">
<h1>Checking the timing table</h1>
<pre class="r"><code>(x &lt;- tic.log() %&gt;%
  as.character() %&gt;% 
  tibble(log = .) %&gt;% 
  separate(log,sep = &#39;: &#39;,into = c(&#39;name&#39;,&#39;time&#39;))) %&gt;% 
  separate(time, sep = &#39; &#39;,c(&#39;measure&#39;,&#39;units&#39;)) %&gt;%
  mutate(measure = measure %&gt;% as.numeric()) %&gt;% 
  arrange(measure %&gt;% desc())</code></pre>
<pre><code>## Warning: Expected 2 pieces. Additional pieces discarded in 31 rows [1, 2, 3, 4,
## 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, ...].</code></pre>
<pre><code>## # A tibble: 31 x 3
##    name                            measure units
##    &lt;chr&gt;                             &lt;dbl&gt; &lt;chr&gt;
##  1 Bayes Search                      26.1  sec  
##  2 naive grid search                  6.25 sec  
##  3 Loading Libraries                  3.64 sec  
##  4 set up parallel                    1.28 sec  
##  5 Data Explorer  individual plots    1    sec  
##  6 Fitting production                 0.28 sec  
##  7 unnamed-chunk-6                    0.18 sec  
##  8 Skimr                              0.16 sec  
##  9 unnamed-chunk-5                    0.16 sec  
## 10 Set Chunk                          0.15 sec  
## # … with 21 more rows</code></pre>
<p>unnamed-chunk-17: 0.02 sec elapsed</p>
</div>
